<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Defect Daily</title>
    <link rel="stylesheet" href="stylesinspection.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="/dashboard">Dashboard</a></li>
            <li><a href="/admin">Admin</a></li>
            <li><a href="/logout">Logout</a></li>
        </ul>
    </nav>

    <h1>FORM DAILY DEFECT RO</h1>

    <form action="/upload" method="post" enctype="multipart/form-data" id="inspectionForm">
        <div>
            <!-- Correctly linked label and input element -->
            <label for="foto">Foto:</label>
            <input type="file" id="foto" name="foto" required onchange="previewFile()">
            <img id="previewImg" src="" alt="Image preview" height="200" style="display: none;"><br>
        </div>

        <div>
            <label for="id_user">Nama:</label>
            <select id="id_user" name="id_user" required>
                <option value="<%= user.id %>"><%= user.name %></option>
            </select>
        </div>
    
        <div>
            <!-- Correctly linked label and select element -->
            <label for="id_tipe_lantai">Lantai:</label>
            <select id="id_tipe_lantai" name="id_tipe_lantai">
                <option value="">Pilih Lantai</option>
                <% tipe_lantai.forEach(tl => { %>
                    <option value="<%= tl.id %>"><%= tl.nama_lantai %></option>
                <% }); %>
            </select>
        </div>
    
        <div>
            <!-- Correctly linked label and select element -->
            <label for="id_kondisi">Work Progress Detail:</label>
            <select id="id_kondisi" name="id_kondisi">
                <option value="">Pilih Kondisi</option>
                <% tipe_kondisi.forEach(tk => { %>
                    <option value="<%= tk.id %>"><%= tk.nama_kondisi %></option>
                <% }); %>
            </select>
        </div>
    
        <div>
            <!-- Correctly linked label and textarea element -->
            <label for="catatan">Issue Defect:</label>
            <textarea id="catatan" name="catatan"></textarea>
        </div>
    
        <div>
            <!-- Correctly linked label and input element -->
            <label for="target_completion_date">Target Completion Date:</label>
            <input type="date" id="target_completion_date" name="target_completion_date" required>
        </div>
    
        <div>
            <!-- Correctly linked label and select element -->
            <label for="id_department">PIC:</label>
            <select id="id_department" name="id_department">
                <option value="">Pilih Department</option>
                <% tipe_department.forEach(department => { %>
                    <option value="<%= department.id %>"><%= department.nama_department %></option>
                <% }); %>
            </select>
        </div>
    
        <button type="submit" id="submitButton">Kirim</button>
    </form>
    
    

    <div id="successMessage" style="display: none; color: green;">Form submitted successfully!</div>
    <div id="errorMessage" style="display: none; color: red;">There was an error submitting the form.</div>

    <script>
        function previewFile() {
            const preview = document.getElementById('previewImg');
            const file = document.getElementById('foto').files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                preview.src = reader.result;
                preview.style.display = 'block';
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
                preview.style.display = 'none';
            }
        }

        document.getElementById('inspectionForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);
            const submitButton = document.getElementById('submitButton');

            submitButton.textContent = 'Mengirim...'; // Change button text to indicate loading
            submitButton.disabled = true; // Disable the button to prevent multiple submissions

            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const successMessage = document.getElementById('successMessage');
                    successMessage.textContent = 'Form submitted successfully!';
                    successMessage.style.display = 'block';

                    // Optionally reset the form
                    document.getElementById('inspectionForm').reset();
                    document.getElementById('previewImg').src = '';
                    document.getElementById('previewImg').style.display = 'none';

                    // Hide the success message after a few seconds
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 5000);
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);

                // Show error message
                const errorMessage = document.getElementById('errorMessage');
                errorMessage.textContent = error.message;
                errorMessage.style.display = 'block';

                // Hide the error message after a few seconds
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            })
            .finally(() => {
                submitButton.textContent = 'Kirim'; // Reset button text
                submitButton.disabled = false; // Re-enable the submit button
            });
        });

        // Set default date to today
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('target_completion_date').value = today;
        });
    </script>
</body>
</html>
